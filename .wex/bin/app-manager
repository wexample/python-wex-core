#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
APP_ROOT="${APP_ROOT:-$ROOT}"
AM_DIR="$ROOT/.wex/python/app_manager"
VENV="$AM_DIR/.venv"
PY="$VENV/bin/python3"

if [ ! -x "$PY" ]; then
  python3 -m venv "$VENV"
  "$PY" -m pip install -U pip wheel
fi

# Prefer local core in editable mode if available; fallback to PyPI dep
CORE_DIR="$ROOT/../../wex-core"
if [ -d "$CORE_DIR" ]; then
  "$PY" -m pip install -e "$CORE_DIR"
else
  # Ensure core from PyPI is present (respect pyproject if you later switch to PDM)
  "$PY" -m pip install -U wexample-wex-core
fi

export APP_ROOT
exec "$PY" -m wexample_wex_core.app_manager -- "$@"